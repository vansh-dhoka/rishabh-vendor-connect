# Rishabh Vendor Connect - Deployment Guide

## Overview
This guide covers deploying the Rishabh Vendor Connect portal to Render with proper monitoring, backups, and production optimizations.

## Architecture
- **Backend**: Node.js/Express API with PostgreSQL
- **Frontend**: React SPA served as static site
- **Database**: PostgreSQL with connection pooling
- **Storage**: Render disk for PDFs and uploads
- **Monitoring**: Built-in health checks and logging

## Prerequisites
1. Render account (free tier available)
2. GitHub repository with the code
3. Domain name (optional, for custom domains)

## Step 1: Database Setup

### Create PostgreSQL Database
1. In Render Dashboard, create a new PostgreSQL database:
   - **Name**: `rishabh-vendor-connect-db`
   - **Plan**: Free (or Starter for production)
   - **Database Name**: `rishabh_vendor_connect`
   - **User**: `rishabh_user`

2. Note the connection string from the database dashboard

### Database Migrations
The backend automatically runs migrations on startup with the `start:production` script:
```bash
npm run migrate && node src/server.js
```

## Step 2: Backend Deployment

### Create Web Service
1. Connect your GitHub repository to Render
2. Create a new Web Service:
   - **Name**: `rishabh-vendor-connect-backend`
   - **Environment**: Node
   - **Plan**: Starter (recommended for production)
   - **Build Command**: `npm ci --only=production`
   - **Start Command**: `npm run start:production`
   - **Health Check Path**: `/health`

### Environment Variables
Set these in the Render dashboard:

**Required:**
```
NODE_ENV=production
JWT_SECRET=<auto-generated-by-render>
DATABASE_URL=<from-database-service>
FRONTEND_URL=https://rishabh-vendor-connect-frontend.onrender.com
```

**Optional:**
```
STORAGE_TYPE=local
UPLOAD_DIR=uploads
PDF_STORAGE_DIR=pdfs
AWS_REGION=us-east-1
AWS_ACCESS_KEY_ID=<if-using-s3>
AWS_SECRET_ACCESS_KEY=<if-using-s3>
S3_BUCKET=<if-using-s3>
```

### Persistent Storage
1. Add a disk to the backend service:
   - **Name**: `rishabh-vendor-connect-storage`
   - **Mount Path**: `/opt/render/project/src/storage`
   - **Size**: 1GB (adjust based on needs)

2. Update environment variables:
   ```
   UPLOAD_DIR=/opt/render/project/src/storage/uploads
   PDF_STORAGE_DIR=/opt/render/project/src/storage/pdfs
   ```

## Step 3: Frontend Deployment

### Create Static Site
1. Create a new Static Site:
   - **Name**: `rishabh-vendor-connect-frontend`
   - **Build Command**: `npm ci && npm run build`
   - **Publish Directory**: `dist`

### Environment Variables
```
VITE_API_URL=https://rishabh-vendor-connect-backend.onrender.com
VITE_APP_NAME=Rishabh Vendor Connect
VITE_APP_VERSION=1.0.0
```

## Step 4: Database Backup Setup

### Automated Backups
1. In the database dashboard, enable automated backups
2. Set backup frequency (daily recommended)
3. Configure retention period (30 days minimum)

### Manual Backup Script
Create a backup script for additional safety:
```bash
#!/bin/bash
# backup-db.sh
pg_dump $DATABASE_URL > backup_$(date +%Y%m%d_%H%M%S).sql
```

## Step 5: Monitoring & Logging

### Health Checks
The application provides several monitoring endpoints:

- **Health Check**: `GET /health`
  - Database connectivity
  - Memory usage
  - Uptime
  - Service status

- **Database Stats**: `GET /api/stats/database` (requires auth)
  - Connection pool status
  - Active connections
  - Database version

- **Application Metrics**: `GET /api/stats/metrics` (requires auth)
  - Memory usage
  - Node.js version
  - Platform info
  - Uptime

### Logging
- **Request Logging**: All requests are logged with timing
- **Error Logging**: Comprehensive error tracking with context
- **Performance Logging**: Slow operations (>1s) are flagged
- **Audit Logging**: All data changes are tracked

### Render Monitoring
1. Enable Render's built-in monitoring
2. Set up alerts for:
   - Service downtime
   - High error rates
   - Slow response times
   - Database connection issues

## Step 6: Security Configuration

### HTTPS
- Automatically enforced in production
- Redirects HTTP to HTTPS
- Uses Render's SSL certificates

### CORS
- Configured for frontend domain
- Credentials enabled for authenticated requests

### Rate Limiting
- 100 requests per minute per IP
- Configurable via environment variables

### Authentication
- JWT-based authentication
- Secure token generation
- Company-scoped access control

## Step 7: Performance Optimization

### Database
- Connection pooling enabled
- Proper indexing on all tables
- Query optimization with pagination
- Soft deletes for data integrity

### Caching
- Static assets served with CDN
- Database query optimization
- Memory usage monitoring

### File Storage
- Structured PDF storage
- File type validation
- Size limits (10MB max)
- Secure file naming

## Step 8: Production Checklist

### Before Go-Live
- [ ] Database migrations completed
- [ ] Environment variables configured
- [ ] Health checks passing
- [ ] SSL certificates active
- [ ] Backup strategy in place
- [ ] Monitoring alerts configured
- [ ] Error logging working
- [ ] Performance benchmarks met

### Post-Deployment
- [ ] Monitor error rates
- [ ] Check database performance
- [ ] Verify file uploads working
- [ ] Test PDF generation
- [ ] Validate audit logging
- [ ] Confirm backup schedule
- [ ] Review security logs

## Troubleshooting

### Common Issues

**Database Connection Errors**
- Check DATABASE_URL format
- Verify database service is running
- Check connection pool settings

**File Upload Issues**
- Verify disk storage is mounted
- Check file permissions
- Validate file size limits

**PDF Generation Problems**
- Check PDF storage directory
- Verify template files exist
- Monitor memory usage

**Performance Issues**
- Review database queries
- Check connection pool usage
- Monitor memory consumption
- Analyze slow request logs

### Log Analysis
```bash
# View recent errors
grep "ERROR" /var/log/app.log

# Check slow requests
grep "Slow Request" /var/log/app.log

# Monitor database connections
grep "database" /var/log/app.log
```

## Scaling Considerations

### Horizontal Scaling
- Use Render's auto-scaling features
- Implement Redis for session storage
- Consider database read replicas

### Vertical Scaling
- Upgrade to higher Render plans
- Increase database resources
- Add more storage capacity

### Cost Optimization
- Monitor resource usage
- Use appropriate plan sizes
- Implement caching strategies
- Optimize database queries

## Maintenance

### Regular Tasks
- Monitor disk usage
- Review error logs
- Update dependencies
- Test backup restoration
- Performance optimization

### Updates
- Deploy updates via Git
- Test in staging environment
- Monitor post-deployment
- Rollback if issues occur

## Support

### Render Support
- Documentation: https://render.com/docs
- Community: https://community.render.com
- Status Page: https://status.render.com

### Application Support
- Health Check: `https://your-app.onrender.com/health`
- Logs: Available in Render dashboard
- Metrics: Built-in monitoring endpoints

## Security Best Practices

1. **Environment Variables**: Never commit secrets to Git
2. **Database Access**: Use connection pooling and proper credentials
3. **File Uploads**: Validate file types and sizes
4. **Authentication**: Implement proper JWT handling
5. **HTTPS**: Always use SSL in production
6. **Monitoring**: Set up alerts for security events
7. **Backups**: Regular automated backups
8. **Updates**: Keep dependencies updated
9. **Logging**: Monitor for suspicious activity
10. **Access Control**: Implement proper authorization

This deployment guide ensures a robust, scalable, and secure production environment for the Rishabh Vendor Connect portal.
